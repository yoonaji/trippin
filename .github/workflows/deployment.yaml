name: Deploy Spring Boot to Cloud Run

on:
  push:
    branches:
      - main
      - backend/develop
      - backend/feature/test
    # main Î∏åÎûúÏπòÏóê Ìë∏ÏãúÎê† Îïå Ïã§Ìñâ

# GCP Ïù∏Ï¶ùÏùÑ ÏúÑÌïú Í∂åÌïú
permissions:
  id-token: write
  contents: read

# ‚≠êÔ∏è Í≥µÌÜµ ÌôòÍ≤Ω Î≥ÄÏàò (Î≥∏Ïù∏ ÌôòÍ≤ΩÏóê ÎßûÍ≤å ÏàòÏ†ï)
env:
  GCP_PROJECT_ID: concrete-acre-477518-s2 # ‚≠êÔ∏è Î≥∏Ïù∏ GCP ÌîÑÎ°úÏ†ùÌä∏ ID
  GCP_REGION: us-central1           # ‚≠êÔ∏è Cloud Run Î¶¨Ï†Ñ (ÏÑúÏö∏)
  GAR_REPOSITORY: trippin-repo             # ‚≠êÔ∏è Artifact Registry Ï†ÄÏû•ÏÜå Ïù¥Î¶Ñ
  SERVICE_NAME: trippin-backend           # ‚≠êÔ∏è Cloud RunÏóê Î∞∞Ìè¨Îê† ÏÑúÎπÑÏä§ Ïù¥Î¶Ñ

jobs:
  deploy-to-cloud-run:
    runs-on: ubuntu-latest
    steps:
      # 1. ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 'gcloud' CLI Ïù∏Ï¶ù (GitHub ActionsÍ∞Ä GCPÏóê Ï†ëÍ∑ºÌïòÍ∏∞ ÏúÑÌï®)
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          # ‚≠êÔ∏è GitHub SecretÏóê Ï†ÄÏû•Ìïú 'GCP_SA_KEY_BASE64' ÏÇ¨Ïö©
          credentials_json: ${{ secrets.GCP_SA_KEY_BASE64 }}

      # 3. Artifact RegistryÏóê Docker Ïù∏Ï¶ù
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      # 4. Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Î∞è Artifact RegistryÎ°ú Ìë∏Ïãú
      - name: Build and Push Docker Image
        id: build-image
        env:
          IMAGE_TAG: ${{ github.sha }} # Ïª§Î∞ã Ìï¥ÏãúÎ°ú ÌÉúÍ∑∏ ÏÉùÏÑ±
          GAR_REGISTRY: ${{ env.GCP_REGION }}-docker.pkg.dev
        run: |
          cd back # ‚≠êÔ∏è DockerfileÏù¥ back/ Ìè¥ÎçîÏóê ÏûàÏúºÎØÄÎ°ú Ïù¥Îèô
          
          # Ï†ÑÏ≤¥ Ïù¥ÎØ∏ÏßÄ Í≤ΩÎ°ú Ï†ïÏùò
          FULL_IMAGE_NAME="$GAR_REGISTRY/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.SERVICE_NAME }}:$IMAGE_TAG"
          
          docker build -t $FULL_IMAGE_NAME .
          docker push $FULL_IMAGE_NAME
          
          # Îã§Ïùå Îã®Í≥ÑÏóêÏÑú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎèÑÎ°ù Ïù¥ÎØ∏ÏßÄ Ïù¥Î¶Ñ Ï†ÄÏû•
          echo "image_name=$FULL_IMAGE_NAME" >> $GITHUB_OUTPUT

      # 5. üöÄ Cloud RunÏóê Î∞∞Ìè¨ (‚≠êÔ∏è Í∞ÄÏû• Ï§ëÏöî)
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          image: ${{ steps.build-image.outputs.image_name }} # 4Îã®Í≥ÑÏóêÏÑú Ìë∏ÏãúÌïú Ïù¥ÎØ∏ÏßÄ
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.GCP_REGION }}



          # ‚≠êÔ∏è GitHub SecretsÏóê Ï†ÄÏû•Îêú ÌôòÍ≤Ω Î≥ÄÏàòÎì§ÏùÑ Cloud RunÏóê Ï£ºÏûÖ
          # (Ï£ºÏùò: Ïó¨Í∏∞Ïóê GOOGLE_APPLICATION_CREDENTIALSÎäî Ï†àÎåÄ ÎÑ£ÏßÄ ÎßàÏÑ∏Ïöî!)
          env_vars: |
            SPRING_DATASOURCE_URL=jdbc:postgresql:///${DB_NAME}?cloudSqlInstance=${INSTANCE_CONNECTION_NAME}            
            SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}
            INSTANCE_CONNECTION_NAME=${{ secrets.INSTANCE_CONNECTION_NAME }}
            GCS_BUCKET=${{ secrets.GCS_BUCKET }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
            NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
            KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
            KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
            GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
            APP_S3_REGION=${{ secrets.APP_S3_REGION }}
            APP_S3_BUCKET=${{ secrets.APP_S3_BUCKET }}
            APP_CDN_DOMAIN=${{ secrets.APP_CDN_DOMAIN }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}
            GCS_BUCKET=${{ secrets.GCS_BUCKET }}
            GCS_DOMAIN=${{ secrets.GCS_DOMAIN }}
            CLOUD_SQL=${{ secrets.CLOUD_SQL }}
            DB_NAME=${{ secrets.DB_NAME }}
            APP_S3_ENABLED: false
            APP_S3_REGION: "disabled"
            APP_S3_BUCKET: "disabled"

          flags: |
            --add-cloudsql-instances=${{ secrets.INSTANCE_CONNECTION_NAME }}