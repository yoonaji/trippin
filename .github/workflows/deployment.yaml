name: Deploy Spring Boot to Cloud Run

on:
  push:
    branches:
      - main
      - backend/feature/test
    # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰

# GCP ì¸ì¦ì„ ìœ„í•œ ê¶Œí•œ
permissions:
  id-token: write
  contents: read

# â­ï¸ ê³µí†µ í™˜ê²½ ë³€ìˆ˜ (ë³¸ì¸ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •)
env:
  GCP_PROJECT_ID: concrete-acre-477518-s2 # â­ï¸ ë³¸ì¸ GCP í”„ë¡œì íŠ¸ ID
  GCP_REGION: us-central1           # â­ï¸ Cloud Run ë¦¬ì „ (ì„œìš¸)
  GAR_REPOSITORY: trippin-repo             # â­ï¸ Artifact Registry ì €ì¥ì†Œ ì´ë¦„
  SERVICE_NAME: trippin-backend           # â­ï¸ Cloud Runì— ë°°í¬ë  ì„œë¹„ìŠ¤ ì´ë¦„

  # â­ï¸ Cloud Runì´ ì‹¤í–‰ë  'ëŸ°íƒ€ì„ ì„œë¹„ìŠ¤ ê³„ì •' ì´ë©”ì¼ (ë§¤ìš° ì¤‘ìš”!)
  # 2ë‹¨ê³„ì—ì„œ ìƒì„±í•  ì„œë¹„ìŠ¤ ê³„ì •ì˜ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ë„£ìœ¼ì„¸ìš”.
  GCP_RUNTIME_SA: trippin-run-sa@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com

jobs:
  deploy-to-cloud-run:
    runs-on: ubuntu-latest
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 'gcloud' CLI ì¸ì¦ (GitHub Actionsê°€ GCPì— ì ‘ê·¼í•˜ê¸° ìœ„í•¨)
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          # â­ï¸ GitHub Secretì— ì €ì¥í•œ 'GCP_SA_KEY_BASE64' ì‚¬ìš©
          credentials_json: ${{ secrets.GCP_SA_KEY_BASE64 }}

      # 3. Artifact Registryì— Docker ì¸ì¦
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Artifact Registryë¡œ í‘¸ì‹œ
      - name: Build and Push Docker Image
        id: build-image
        env:
          IMAGE_TAG: ${{ github.sha }} # ì»¤ë°‹ í•´ì‹œë¡œ íƒœê·¸ ìƒì„±
          GAR_REGISTRY: ${{ env.GCP_REGION }}-docker.pkg.dev
        run: |
          cd back # â­ï¸ Dockerfileì´ back/ í´ë”ì— ìˆìœ¼ë¯€ë¡œ ì´ë™
          
          # ì „ì²´ ì´ë¯¸ì§€ ê²½ë¡œ ì •ì˜
          FULL_IMAGE_NAME="$GAR_REGISTRY/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.SERVICE_NAME }}:$IMAGE_TAG"
          
          docker build -t $FULL_IMAGE_NAME .
          docker push $FULL_IMAGE_NAME
          
          # ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì´ë¯¸ì§€ ì´ë¦„ ì €ì¥
          echo "image_name=$FULL_IMAGE_NAME" >> $GITHUB_OUTPUT

      # 5. ğŸš€ Cloud Runì— ë°°í¬ (â­ï¸ ê°€ì¥ ì¤‘ìš”)
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloud-run@v2
        with:
          image: ${{ steps.build-image.outputs.image_name }} # 4ë‹¨ê³„ì—ì„œ í‘¸ì‹œí•œ ì´ë¯¸ì§€
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.GCP_REGION }}

          # â­ï¸ Cloud Runì´ ì‹¤í–‰ë  ì„œë¹„ìŠ¤ ê³„ì • (DB, GCS ì ‘ê·¼ ê¶Œí•œ í•„ìš”)
          service_account: ${{ env.GCP_RUNTIME_SA }}

          # â­ï¸ Cloud SQL ì¸ìŠ¤í„´ìŠ¤ ì—°ê²° (INSTANCE_CONNECTION_NAME ì‹œí¬ë¦¿ ê°’)
          add_cloudsql_instances: ${{ secrets.INSTANCE_CONNECTION_NAME }}

          # â­ï¸ GitHub Secretsì— ì €ì¥ëœ í™˜ê²½ ë³€ìˆ˜ë“¤ì„ Cloud Runì— ì£¼ì…
          # (ì£¼ì˜: ì—¬ê¸°ì— GOOGLE_APPLICATION_CREDENTIALSëŠ” ì ˆëŒ€ ë„£ì§€ ë§ˆì„¸ìš”!)
          env_vars: |
            SPRING_DATASOURCE_URL=jdbc:postgresql:///${{ secrets.DB_NAME }}?socketFactory=com.google.cloud.sql.postgres.SocketFactory&cloudSqlInstance=${{ secrets.INSTANCE_CONNECTION_NAME }}
            SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}
            INSTANCE_CONNECTION_NAME=${{ secrets.INSTANCE_CONNECTION_NAME }}
            GCS_BUCKET=${{ secrets.GCS_BUCKET }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
            NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
            KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
            KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
            GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
            APP_S3_REGION=${{ secrets.APP_S3_REGION }}
            APP_S3_BUCKET=${{ secrets.APP_S3_BUCKET }}
            APP_CDN_DOMAIN=${{ secrets.APP_CDN_DOMAIN }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}
            GCS_BUCKET=${{ secrets.GCS_BUCKET }}
            GCS_DOMAIN=${{ secrets.GCS_DOMAIN }}
            CLOUD_SQL=${{ secrets.CLOUD_SQL }}