name: Deployment

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ap-northeast-2
      EKS_CLUSTER_NAME: trippin-cluster
      ECR_REPOSITORY: trippin-backend
      NS: default
      DEPLOY: trippin-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Ensure ECR repo
        run: |
          aws ecr describe-repositories --repository-names "${{ env.ECR_REPOSITORY }}" >/dev/null 2>&1 \
          || aws ecr create-repository --repository-name "${{ env.ECR_REPOSITORY }}" >/dev/null

      - name: Build & Push Docker image
        env:
          ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd back
          docker build -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG .
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG

      - name: Kubeconfig
        run: aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}

      - name: Bootstrap secrets & first resources
        env:
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          kubectl -n "$NS" create secret generic trippin-db \
            --from-literal=username="$DB_USERNAME" \
            --from-literal=password="$DB_PASSWORD" \
            --from-literal=url="${{ secrets.SPRING_DATASOURCE_URL }}" \
            --dry-run=client -o yaml | kubectl apply -f -

          if ! kubectl -n "$NS" get deploy "$DEPLOY" >/dev/null 2>&1; then
            IMG="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"
            sed -e "s#IMAGE_PLACEHOLDER#${IMG}#g" aws/k8s/deployment.yaml | kubectl -n "$NS" apply -f -
            kubectl -n "$NS" apply -f aws/k8s/service.yaml
          else
            kubectl -n "$NS" apply -f aws/k8s/service.yaml
          fi

      # - name: Apply ingress
      #   if: ${{ hashFiles('aws/ingress.yaml') != '' }}
      #   run: kubectl -n "$NS" apply -f aws/ingress.yaml

      - name: Deploy to EKS
        env:
          ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -e
          CONTAINER=$(kubectl -n "$NS" get deploy "$DEPLOY" -o jsonpath='{.spec.template.spec.containers[0].name}')
          echo "Container: $CONTAINER"
          kubectl -n "$NS" set image deployment/$DEPLOY $CONTAINER=$ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG
          kubectl -n "$NS" rollout status deployment/$DEPLOY --timeout=5m
